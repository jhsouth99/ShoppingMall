<%@ page language="java" contentType="text/html; charset=UTF-8"
         pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<!DOCTYPE html>
<html lang="ko">
<head>
    <jsp:include page="/WEB-INF/views/common/meta.jsp" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${product.name}-ÏÉÅÌíà ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ</title>

    <!-- Ïô∏Î∂Ä ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <link
            href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
            rel="stylesheet">
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet">

    <!-- Ïπ¥Ïπ¥Ïò§ SDK -->
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
    <script>
        // Ïπ¥Ïπ¥Ïò§ SDK Ï¥àÍ∏∞Ìôî (Ïã§Ï†ú Ïï± ÌÇ§Î°ú ÍµêÏ≤¥ ÌïÑÏöî)
        Kakao.init('YOUR_KAKAO_APP_KEY');
    </script>

    <!-- ÌîÑÎ°úÏ†ùÌä∏ CSS -->
    <link rel="stylesheet"
          href="${pageContext.request.contextPath}/resources/css/common.css">
    <link rel="stylesheet"
          href="${pageContext.request.contextPath}/resources/css/product-detail.css">
</head>

<body>
<!-- Ìó§Îçî Ìè¨Ìï® -->
<%@ include file="/WEB-INF/views/common/header.jsp"%>

<!-- Ïä§ÌÅ¨Î°§ Î≤ÑÌäº -->
<i class="fa-solid fa-angle-up" id="top_scroll_btn" onclick="topScroll()"></i>
<i class="fa-regular fa-angle-down" id="bottom_scroll_btn" onclick="bottomScroll()"></i>

<!-- Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà -->
<div class="container">

    <!-- ÏÉÅÌíà Ï†ïÎ≥¥ Ïª®ÌÖåÏù¥ÎÑà -->
    <div class="product-container">
        <!-- Ï†úÌíà Ïù¥ÎØ∏ÏßÄ ÏòÅÏó≠ -->
        <div class="product-images">
            <img id="mainImage" class="main-image"
                 src="${pageContext.request.contextPath}${product.thumbnailUrl}"
                 alt="${product.name} Î©îÏù∏ Ïù¥ÎØ∏ÏßÄ"
                 data-product-id="${product.id}">

            <c:if test="${not empty product.images}">
                <div class="thumbnail-container">
                    <c:forEach var="image" items="${product.images}"
                               varStatus="status">
                        <c:if test="${image.imageType ne 'DETAIL'}">
                            <img class="thumbnail ${status.index == 0 ? 'active' : ''}"
                                 src="${pageContext.request.contextPath}${image.imageUrl}"
                                 alt="${product.name} Ïù¥ÎØ∏ÏßÄ ${status.index + 1}"
                                 onclick="changeImage(this, '${pageContext.request.contextPath}${image.imageUrl}')">
                        </c:if>
                    </c:forEach>
                </div>
            </c:if>
        </div>

        <!-- Ï†úÌíà Ï†ïÎ≥¥ ÏòÅÏó≠ -->
        <div class="product-info">
            <h1 class="product-title">${product.name}</h1>

            <!-- Í≥µÏú† Î≤ÑÌäº -->
            <div class="share-sns-buttons">
                <button class="share-button">
                    <i class="fas fa-share-alt"></i>
                </button>
                <ul id="sns-buttons">
                    <li><a href="#" onclick="shareToKakao(); return false;"><i class="fas fa-comment"></i></a></li>
                    <li><a href="#" onclick="shareToFacebook(); return false;"><i class="fab fa-facebook"></i></a></li>
                    <li><i class="fas fa-link" onclick="copyLink();"></i></li>
                    <li id="cancel" onclick="hideShareBar();">‚úï</li>
                </ul>
            </div>

            <!-- ÏÉÅÌíà ÏÑ§Î™Ö -->
            <p class="product-description">${product.description}</p>

            <!-- ÏÉÅÌíà ÏòµÏÖò -->
            <form action="">
                <div class="product-options">
                    <c:if test="${not empty product.options}">
                    <c:forEach var="option" items="${product.options}">
                    <label class="option-label">${option.name}</label>
                    <select class="option-select" data-option-name="${option.name}"
                            onchange="updateVariantOptions();">
                        <option value="">${option.name}ÏùÑ(Î•º)ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        <c:forEach var="value" items="${option.values}">
                            <option value="${value.value}"
                                    <c:if test="${not empty defaultOptions && defaultOptions[option.name] == value.value}">
                                        selected="selected"
                                    </c:if>>
                                    ${value.value}
                            </option>
                        </c:forEach>
                    </select>
                    </c:forEach>
                    </c:if>

                    <!-- ÏàòÎüâ ÏÑ†ÌÉù -->
                    <label class="option-label">ÏàòÎüâ</label>
                    <div class="quantity-container">
                        <div class="quantity-button" onclick="decreaseQuantity()">-</div>
                        <input id="quantityInput" type="number" min="1" value="1"
                               class="quantity-input" onchange="updateTotalPrice()">
                        <div class="quantity-button" onclick="increaseQuantity()">+</div>
                    </div>
            </form>
        </div>

        <!-- Ï¥ù Í∏àÏï° (Í∞ÄÍ≤© Ï†ïÎ≥¥ ÌÜµÌï©) -->
        <div class="total-price">
            <div class="price-info">
                <span class="price-label">Ï¥ù Í∏àÏï°:</span>
                <div class="price-display">
                    <c:choose>
                        <c:when test="${not empty proPrice}">
                            <div class="original-price">
                                <fmt:formatNumber value="${product.basePrice}" type="number" groupingUsed="true" />Ïõê
                            </div>
                            <div class="discount-info">
                                <c:if test="${proPrice.proDiscountType eq 'PERCENTAGE'}">
                                    <span class="discount-rate">${proPrice.proDiscountValue}%</span>
                                </c:if>
                                <c:if test="${proPrice.proDiscountType eq 'FIXED_AMOUNT'}">
                                    <span class="discount-rate">
                                        <fmt:formatNumber value="${proPrice.proDiscountValue}"
                                                          type="number" maxFractionDigits="0"/>%
                                    </span>
                                </c:if>
                            </div>
                        </c:when>
                    </c:choose>
                    <div class="current-price" id="totalPrice">
                        <c:choose>
                            <c:when test="${not empty proPrice}">
                                <c:if test="${proPrice.proDiscountType eq 'PERCENTAGE'}">
                                    <fmt:formatNumber value="${product.basePrice - (product.basePrice * (proPrice.proDiscountValue/100))}"
                                                      type="number" groupingUsed="true" />Ïõê
                                </c:if>
                                <c:if test="${proPrice.proDiscountType eq 'FIXED_AMOUNT'}">
                                    <fmt:formatNumber value="${product.basePrice - proPrice.proDiscountValue}"
                                                      type="number" groupingUsed="true" />Ïõê
                                </c:if>
                            </c:when>
                            <c:otherwise>
                                <fmt:formatNumber value="${product.basePrice}" type="number" groupingUsed="true" />Ïõê
                            </c:otherwise>
                        </c:choose>
                    </div>
                </div>
            </div>
        </div>

        <!-- Íµ¨Îß§ Î≤ÑÌäº Í∑∏Î£π -->
        <div class="button-group">
            <button class="buy-now-button" onclick="buyNow();">
                <span id="buyNowPrice">
                    <c:choose>
                        <c:when test="${not empty proPrice}">
                            <c:if test="${proPrice.proDiscountType eq 'PERCENTAGE'}">
                                <fmt:formatNumber value="${product.basePrice - proPrice.proDiscountFixed}"
                                                  type="number" groupingUsed="true" />Ïõê
                            </c:if>
                            <c:if test="${proPrice.proDiscountType eq 'FIXED_AMOUNT'}">
                                <fmt:formatNumber value="${product.basePrice - proPrice.proDiscountFixed}"
                                                  type="number" groupingUsed="true" />Ïõê
                            </c:if>
                        </c:when>
                        <c:otherwise>
                            <fmt:formatNumber value="${product.basePrice}" type="number" groupingUsed="true" />Ïõê
                        </c:otherwise>
                    </c:choose>
                </span><br>
                Î∞îÎ°ú Íµ¨Îß§
            </button>

            <button class="add-to-cart-button" onclick="addToCart();">Ïû•Î∞îÍµ¨Îãà</button>
            <button id="wish-button" onclick="toggleWishlist(${product.id});">
                <i class="fas fa-heart"></i>
            </button>
        </div>
    </div>
</div>


<!-- ÌîÑÎ°úÎ™®ÏÖò Î∞è Ìï†Ïù∏ Ï†ïÎ≥¥ -->
<c:if test="${not empty activePromotions}">
    <div class="promotion-section">
        <h3 class="promotion-title">üéâ ÏßÑÌñâÏ§ëÏù∏ Ìï†Ïù∏ ÌòúÌÉù (Í∞ÄÏû• ÌòúÌÉùÏù¥ ÌÅ∞ Í≤É ÌïòÎÇòÎßå ÏûêÎèô Î∞òÏòÅÎê®)</h3>
        <c:forEach var="promotion" items="${activePromotions}">
            <div class="promotion-item" data-promotion-id="${promotion.id}">
                <div class="promotion-badge ${promotion.promotionType}">
                    <c:choose>
                        <c:when test="${promotion.promotionType == 'PRODUCT_DISCOUNT'}">ÏÉÅÌíàÌï†Ïù∏</c:when>
                        <c:when test="${promotion.promotionType == 'CART_DISCOUNT'}">Ïû•Î∞îÍµ¨ÎãàÌï†Ïù∏</c:when>
                        <c:when test="${promotion.promotionType == 'BUNDLE_DISCOUNT'}">Î¨∂ÏùåÌï†Ïù∏</c:when>
                        <c:otherwise>ÌäπÎ≥ÑÌï†Ïù∏</c:otherwise>
                    </c:choose>
                </div>
                <div class="promotion-content">
                    <div class="promotion-name">${promotion.name}</div>
                    <div class="promotion-discount">
                        <c:choose>
                            <c:when test="${promotion.discountType == 'PERCENTAGE'}">
                                <span class="discount-rate">${promotion.discountValue}%</span> Ìï†Ïù∏
                                <c:if
                                        test="${promotion.maxDiscountAmount != null}">
                                    (ÏµúÎåÄ <fmt:formatNumber
                                        value="${promotion.maxDiscountAmount}" type="number"
                                        groupingUsed="true" />Ïõê)
                                </c:if>
                            </c:when>
                            <c:when test="${promotion.discountType == 'FIXED_AMOUNT'}">
                                <fmt:formatNumber value="${promotion.discountValue}"
                                                  type="number" groupingUsed="true" />Ïõê Ìï†Ïù∏
                            </c:when>
                        </c:choose>
                    </div>
                    <c:if test="${not empty promotion.description}">
                        <div class="promotion-description">${promotion.description}</div>
                    </c:if>
                    <div class="promotion-period">
                        <c:out value="${promotion.startDate}" />
                        ~
                        <c:choose>
                            <c:when test="${promotion.endDate != null}">
                                <c:out value="${promotion.endDate}" />
                            </c:when>
                            <c:otherwise>ÏÉÅÏãú</c:otherwise>
                        </c:choose>
                    </div>
                </div>
            </div>
        </c:forEach>
    </div>
</c:if>

<!-- ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïø†Ìè∞ Ï†ïÎ≥¥ -->
<c:if test="${not empty availableCoupons}">
    <div class="coupon-section">
        <h3 class="coupon-title">üé´ ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïø†Ìè∞</h3>
        <div class="coupon-list">
            <c:forEach var="coupon" items="${availableCoupons}"
                       varStatus="status">
                <c:if test="${status.index < 3}">
                    <!-- ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÌëúÏãú -->
                    <div
                            class="coupon-item ${coupon.applicable == 'Y' ? 'applicable' : 'not-applicable'}"
                            data-coupon-code="${coupon.couponCode}">
                        <div class="coupon-discount">
                            <c:choose>
                                <c:when test="${coupon.discountType == 'PERCENTAGE'}">
                                    ${coupon.discountValue}%
                                </c:when>
                                <c:when test="${coupon.discountType == 'FIXED_AMOUNT'}">
                                    <fmt:formatNumber value="${coupon.discountValue}"
                                                      type="number" groupingUsed="true" />Ïõê
                                </c:when>
                            </c:choose>
                        </div>
                        <div class="coupon-info">
                            <div class="coupon-name">${coupon.name}</div>
                            <c:if test="${coupon.minPurchaseAmount != null}">
                                <div class="coupon-condition">
                                    <fmt:formatNumber value="${coupon.minPurchaseAmount}"
                                                      type="number" groupingUsed="true" />
                                    Ïõê Ïù¥ÏÉÅ Íµ¨Îß§Ïãú
                                </div>
                            </c:if>
                            <div class="coupon-expiry">
                                <c:out
                                        value="${fn:replace(coupon.validTo.toString(), '-', '.')}" />
                                ÍπåÏßÄ
                            </div>
                        </div>
                    </div>
                </c:if>
            </c:forEach>
            <c:if test="${availableCoupons.size() > 3}">
                <div class="more-coupons">
                    <button onclick="showAllCoupons()" class="show-more-btn">
                        +${availableCoupons.size() - 3}Í∞ú Ïø†Ìè∞ ÎçîÎ≥¥Í∏∞</button>
                </div>
            </c:if>
        </div>
    </div>
</c:if>

<!-- ÏµúÏ¢Ö Ìï†Ïù∏ Ï†ÅÏö© Í∞ÄÍ≤© ÌëúÏãú -->
<div class="final-price-section">
    <div class="price-breakdown">
        <div class="original-price-line">
            <span>Ï†ïÍ∞Ä</span>
            <span id="originalPriceDisplay">
                <c:choose>
                    <c:when test="${not empty product.variants and product.variants.size() > 0}">
                        <fmt:formatNumber value="${product.variants[0].price}" type="number" groupingUsed="true" />Ïõê
                    </c:when>
                    <c:otherwise>
                        <fmt:formatNumber value="${product.basePrice}" type="number" groupingUsed="true" />Ïõê
                    </c:otherwise>
                </c:choose>
            </span>
        </div>
        <div class="promotion-discount-line" style="display: none;">
            <span>ÌîÑÎ°úÎ™®ÏÖò Ìï†Ïù∏</span>
            <span id="promotionDiscountDisplay" class="discount-amount">-0Ïõê</span>
        </div>
        <div class="coupon-discount-line" style="display: none;">
            <span>Ïø†Ìè∞ Ìï†Ïù∏</span>
            <span id="couponDiscountDisplay" class="discount-amount">-0Ïõê</span>
        </div>
        <div class="shipping-fee-line">
            <span>Î∞∞ÏÜ°ÎπÑ</span>
            <span id="shippingFeeDisplay">
                <c:choose>
                    <c:when test="${product.shippingFee != null && product.shippingFee > 0}">
                        +<fmt:formatNumber value="${product.shippingFee}" type="number" groupingUsed="true" />Ïõê
                    </c:when>
                    <c:otherwise>
                        Î¨¥Î£åÎ∞∞ÏÜ°
                    </c:otherwise>
                </c:choose>
            </span>
        </div>
        <div class="final-price-line">
            <span>ÏµúÏ¢Ö Í∞ÄÍ≤©</span>
            <span id="finalPriceDisplay" class="final-price">
                <c:choose>
                    <c:when test="${not empty proPrice}">
                        <c:if test="${proPrice.proDiscountType eq 'PERCENTAGE'}">
                            <fmt:formatNumber value="${product.basePrice - proPrice.proDiscountFixed + (product.shippingFee != null ? product.shippingFee : 0)}"
                                              type="number" groupingUsed="true" />Ïõê
                        </c:if>
                        <c:if test="${proPrice.proDiscountType eq 'FIXED_AMOUNT'}">
                            <fmt:formatNumber value="${product.basePrice - proPrice.proDiscountFixed + (product.shippingFee != null ? product.shippingFee : 0)}"
                                              type="number" groupingUsed="true" />Ïõê
                        </c:if>
                    </c:when>
                    <c:otherwise>
                        <fmt:formatNumber value="${product.basePrice + (product.shippingFee != null ? product.shippingFee : 0)}" type="number" groupingUsed="true" />Ïõê
                    </c:otherwise>
                </c:choose>
            </span>
        </div>
    </div>
</div>

<!-- ÏßÑÌñâ Ï§ëÏù∏ Í≥µÎèôÍµ¨Îß§ Î™©Î°ù -->
<c:if test="${not empty activeGroupBuys}">
    <div class="buy-team-state">
        <h4>ÏßÑÌñâ Ï§ëÏù∏ Í≥µÎèôÍµ¨Îß§ Î™©Î°ù</h4>
        <hr>
        <div class="table-responsive">
            <table>
                <thead>
                <tr>
                    <th>Í≥µÎèôÍµ¨Îß§Î™Ö</th>
                    <th>Í≥µÎèôÍµ¨Îß§Í∞Ä</th>
                    <th>Ï∞∏Ïó¨/Î™©Ìëú ÏàòÎüâ</th>
                    <th>ÎÇ®ÏùÄ ÏàòÎüâ</th>
                    <th>ÎÇ®ÏùÄ ÏãúÍ∞Ñ</th>
                    <th>ÎßàÍ∞êÍ∏∞Ìïú</th>

                    <th>Ïï°ÏÖò</th>
                </tr>
                </thead>
                <tbody>
                <c:forEach var="groupBuy" items="${activeGroupBuys}"
                           varStatus="status">
                    <tr class="team-list-${groupBuy.id}">
                        <td>${groupBuy.name}</td>
                        <td><fmt:formatNumber value="${groupBuy.groupPrice}"
                                              type="number" groupingUsed="true" />Ïõê</td>
                        <td class="personnel-state">${groupBuy.currentQuantity}/${groupBuy.targetQuantity}</td>
                        <td class="rest-personnel"><span>${groupBuy.targetQuantity - groupBuy.currentQuantity}Î™Ö</span>
                            ÎÇ®Ïùå</td>
                        <td class="rest-time" data-end-date="${groupBuy.endDate.time}">Í≥ÑÏÇ∞
                            Ï§ë...</td>
                        <td class="deadline"><fmt:formatDate
                                value="${groupBuy.endDate}" pattern="yyyy-MM-dd HH:mm" /></td>
                        <td class="team-buttons"><c:choose>
                            <c:when
                                    test="${groupBuy.currentQuantity >= groupBuy.targetQuantity}">
                                <button class="join-team-button completed" disabled>Î™®ÏßëÏôÑÎ£å</button>
                            </c:when>
                            <c:otherwise>
                                <button class="join-team-button"
                                        onclick="joinGroupBuy(${groupBuy.id});">Ï∞∏Ïó¨ÌïòÍ∏∞</button>
                            </c:otherwise>
                        </c:choose></td>
                    </tr>
                </c:forEach>
                </tbody>
            </table>
        </div>
    </div>
</c:if>

<!-- ÌÉ≠ Î©îÎâ¥ ÏòÅÏó≠ -->
<div class="product-tabs">
    <div class="tab-buttons">
        <button class="tab-button active"
                onclick="openTab(event, 'detailTab')">ÏÉÅÏÑ∏ Ï†ïÎ≥¥</button>
        <button class="tab-button" onclick="openTab(event, 'specTab')">Ï†úÌíà
            ÏÇ¨Ïñë</button>
        <button class="tab-button" onclick="openTab(event, 'shippingTab')">Î∞∞ÏÜ°/ÌôòÎ∂à</button>
        <button class="tab-button" onclick="openTab(event, 'reviewTab')">
            Î¶¨Î∑∞
            <c:if test="${product.reviewCount > 0}">(${product.reviewCount})</c:if>
        </button>
        <button class="tab-button" onclick="openTab(event, 'qnaTab')">
            Î¨∏Ïùò
            <c:if test="${product.qnaCount > 0}">(${product.qnaCount})</c:if>
        </button>
    </div>

    <!-- ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌÉ≠ -->
    <div id="detailTab" class="tab-content active">
        ${product.detailedContent}

        <!-- DETAIL ÌÉÄÏûÖ Ïù¥ÎØ∏ÏßÄÎì§ÏùÑ ÏÉÅÏÑ∏ ÏÑ§Î™Ö ÏïÑÎûòÏóê Ï∂îÍ∞Ä -->
        <c:if test="${not empty product.images}">
            <c:forEach var="image" items="${product.images}">
                <c:if test="${image.imageType eq 'DETAIL'}">
                    <div class="detail-image-wrapper">
                        <img class="detail-image"
                             src="${pageContext.request.contextPath}${image.imageUrl}"
                             alt="${image.altText != null ? image.altText : product.name}"
                             loading="lazy">
                    </div>
                </c:if>
            </c:forEach>
        </c:if>
    </div>

    <!-- Ï†úÌíà ÏÇ¨Ïñë ÌÉ≠ -->
    <div id="specTab" class="tab-content">
        <table class="spec-table">
            <tr>
                <th>Ï†úÌíàÎ™Ö</th>
                <td>${product.name}</td>
            </tr>
            <c:if test="${not empty product.attributes}">
                <c:forEach var="attr" items="${product.attributes}">
                    <tr>
                        <th>${attr.attributeName}</th>
                        <td>${attr.value}</td>
                    </tr>
                </c:forEach>
            </c:if>
        </table>
    </div>

    <!-- Î∞∞ÏÜ°/ÌôòÎ∂à ÌÉ≠ -->
    <div id="shippingTab" class="tab-content">
        <h3>Î∞∞ÏÜ° Ï†ïÎ≥¥</h3>
        <ul>
            <li>Î∞∞ÏÜ° Î∞©Î≤ï: ÌÉùÎ∞∞</li>
            <li>Î∞∞ÏÜ° ÏßÄÏó≠: Ï†ÑÍµ≠</li>
            <li>Î∞∞ÏÜ° ÎπÑÏö©: 3,000Ïõê</li>
            <li>Î∞∞ÏÜ° Í∏∞Í∞Ñ: Í≤∞Ï†ú ÌôïÏù∏ ÌõÑ 1~3Ïùº Ïù¥ÎÇ¥ Î∞úÏÜ° (Ï£ºÎßê, Í≥µÌú¥Ïùº Ï†úÏô∏)</li>
        </ul>

        <h3>ÍµêÌôò Î∞è Î∞òÌíà ÏïàÎÇ¥</h3>
        <ul>
            <li>ÍµêÌôò/Î∞òÌíà Ïã†Ï≤≠ Í∏∞Í∞Ñ: ÏÉÅÌíà ÏàòÎ†π ÌõÑ 7Ïùº Ïù¥ÎÇ¥</li>
            <li>ÍµêÌôò/Î∞òÌíà Î∞∞ÏÜ°ÎπÑ: Íµ¨Îß§Ïûê Î∂ÄÎã¥</li>
            <li>ÍµêÌôò/Î∞òÌíà Î∂àÍ∞Ä ÏÇ¨Ïú†: Ï∞©Ïö© ÌùîÏ†Å, Ïò§Ïóº, ÌõºÏÜêÎêú ÏÉÅÌíà, ÎùºÎ≤® Ï†úÍ±∞, ÏÉÅÌíà Ìè¨Ïû• ÌõºÏÜê</li>
            <li>ÏÜåÎπÑÏûê ÌîºÌï¥ Î≥¥ÏÉÅ ÌôòÎ∂à ÏßÄÏó∞Ïóê Îî∞Î•∏ Î∞∞ÏÉÅ: Ï†ÑÏûêÏÉÅÍ±∞Îûò Îì±ÏóêÏÑúÏùò ÏÜåÎπÑÏûê Î≥¥Ìò∏Ïóê Í¥ÄÌïú Î≤ïÎ•†Ïóê Îî∞Îùº Ï≤òÎ¶¨</li>
        </ul>
    </div>

    <!-- Î¶¨Î∑∞ ÌÉ≠ -->
    <div id="reviewTab" class="tab-content">
        <div id="reviewList">
            <!-- Î¶¨Î∑∞ Î™©Î°ùÏùÄ AJAXÎ°ú Î°úÎìú -->
            <div class="loading">Î¶¨Î∑∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        </div>
    </div>

    <!-- Î¨∏Ïùò ÌÉ≠ -->
    <div id="qnaTab" class="tab-content">
        <div id="qnaList">
            <!-- Q&A Î™©Î°ùÏùÄ AJAXÎ°ú Î°úÎìú -->
            <div class="loading">Î¨∏ÏùòÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        </div>
    </div>
</div>

<!-- Í¥ÄÎ†® ÏÉÅÌíà -->
<div class="related_pro_container">
    <h2>Í¥ÄÎ†® ÏÉÅÌíà</h2>
    <div class="rel_pro_card_container">
        <c:choose>
            <c:when test="${ empty relPro }">
                <span>Í¥ÄÎ†® ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§</span>
            </c:when>
            <c:otherwise>
                <c:forEach var="relPro" items="${ relPro }">
                    <div class="rel_pro_card" onclick="location.href='${pageContext.request.contextPath}/products/${relPro.id}'">
                        <!-- Ïù¥ÎØ∏ÏßÄ -->
                        <div class="rel_pro_image">
                            <c:choose>
                                <c:when test="${ empty relPro.relProImageUrl }">
                                    <img src="" alt="Ïù¥ÎØ∏ÏßÄ Ïò§Î•ò"/>
                                </c:when>
                                <c:otherwise>
                                    <img src="${pageContext.request.contextPath}${ relPro.relProImageUrl }" alt="${ relPro.relProAltText }"/>
                                </c:otherwise>
                            </c:choose>
                        </div>

                        <!-- Î±ÉÏßÄ -->
                        <c:if test="${ relPro.relProDiscountRate ne null and relPro.relProDiscountRate ne 0 }">
                            <div class="discount_badge">
                                <fmt:formatNumber value="${ relPro.relProDiscountRate }" maxFractionDigits="0"/>%
                            </div>
                        </c:if>
                        <c:if test="${ relPro.relProGroupBuyIsActive == 'ACTIVE' }">
                            <div class="group_badge">Í≥µÎèôÍµ¨Îß§</div>
                        </c:if>

                        <!-- Í¥ÄÎ†® ÏÉÅÌíà Ï†ïÎ≥¥ -->
                        <div class="rel_pro_info">
                            <h3 class="rel_pro_title">${ relPro.relProName }</h3>
                            <span class="rel_pro_price">
									<c:choose>
                                        <c:when test="${ relPro.relProDiscountRate ne null && relPro.relProDiscountRate ne 0 }">
                                            <del><fmt:formatNumber value="${ relPro.relProBasePrice }" maxFractionDigits="0"/>Ïõê</del>&nbsp;
                                            <b style="color: #dc3545;"><fmt:formatNumber value="${ relPro.relProFinalPrice }" maxFractionDigits="0"/>Ïõê</b>
                                        </c:when>
                                        <c:otherwise>
                                            <b><fmt:formatNumber value="${ relPro.relProFinalPrice }" maxFractionDigits="0"/>Ïõê</b>
                                        </c:otherwise>
                                    </c:choose>
								</span>

                            <!-- Í≥µÎèôÍµ¨Îß§ Ï†ïÎ≥¥ -->
                            <c:choose>
                                <c:when test="${ not empty relPro.relProGroupBuyIsActive and relPro.relProGroupBuyIsActive eq 'ACTIVE' }">
                                    <div class="group-purchase-info">
                                        <div class="group-price">
                                            Í≥µÎèôÍµ¨Îß§Ïãú:
                                            <fmt:formatNumber value="${ relPro.relProMinGroupBuyPrice }" pattern="#,###"/>Ïõê
                                        </div>
                                    </div>
                                </c:when>
                                <c:otherwise>
                                    <div class="non-group-purchase-info">
                                        <div class="non-group-price">
                                            Í≥µÎèôÍµ¨Îß§Ïãú:
                                            <fmt:formatNumber value="${ relPro.relProMinGroupBuyPrice }" pattern="#,###"/>Ïõê
                                        </div>
                                    </div>
                                </c:otherwise>
                            </c:choose>
                        </div>
                    </div>
                </c:forEach>
            </c:otherwise>
        </c:choose>
    </div>
</div>

</div>


<!-- Ïù¥ÎØ∏ÏßÄ ÌôïÎåÄ Î™®Îã¨ -->
<div id="imageModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span> <img
            id="modalImage" class="modal-image" src="" alt="ÌôïÎåÄ Ïù¥ÎØ∏ÏßÄ">
    </div>
</div>


<!-- Î¨∏ÏùòÎì±Î°ù Î™®Îã¨ -->
<div id="qnaList"></div>


<!-- Ìë∏ÌÑ∞ Ìè¨Ìï® -->
<%@ include file="/WEB-INF/views/common/footer.jsp"%>

<!-- JavaScript -->
<script
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script
        src="${pageContext.request.contextPath}/resources/js/product-detail.js"></script>

<!-- ÌéòÏù¥ÏßÄ Îç∞Ïù¥ÌÑ∞ Ï†ÑÎã¨ -->
<script>
    // ÏÑúÎ≤ÑÏóêÏÑú Ï†ÑÎã¨Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞Î•º JavaScript Î≥ÄÏàòÎ°ú ÏÑ§Ï†ï
    window.productData = {
        id: ${product.id},
        productId: ${product.id},
        name: '${product.name}',
        basePrice: ${product.basePrice},
        variants: [
            <c:forEach var="variant" items="${product.variants}" varStatus="status">
            {
                id: ${variant.id},
                price: ${variant.price},
                stockQuantity: ${variant.stockQuantity},
                optionCombination: '${variant.optionCombination}',
                isActive: ${variant.isActive}
            }${!status.last ? ',' : ''}
            </c:forEach>
        ],

        // ÏµúÏ†ÄÍ∞Ä variant Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        minPriceVariant: <c:if test="${not empty minPriceVariant}">
            {
                id: ${minPriceVariant.id},
                price: ${minPriceVariant.price},
                stockQuantity: ${minPriceVariant.stockQuantity},
                optionCombination: '${minPriceVariant.optionCombination}',
                isActive: ${minPriceVariant.isActive}
            }
        </c:if><c:if test="${empty minPriceVariant}">null</c:if>,

        // Í∏∞Î≥∏ ÏÑ†ÌÉù ÏòµÏÖò Ï†ïÎ≥¥
        defaultOptions: <c:if test="${not empty defaultOptions}">
            {
                <c:forEach var="entry" items="${defaultOptions}" varStatus="status">
                '${entry.key}': '${entry.value}'${!status.last ? ',' : ''}
                </c:forEach>
            }
        </c:if><c:if test="${empty defaultOptions}">null</c:if>,

        groupBuys: [
            <c:forEach var="groupBuy" items="${groupBuys}" varStatus="status">
            {
                id: ${groupBuy.id},
                name: '${groupBuy.name}',
                productVariantId: ${groupBuy.productVariantId},
                groupPrice: ${groupBuy.groupPrice},
                targetQuantity: ${groupBuy.targetQuantity},
                currentQuantity: ${groupBuy.currentQuantity},
                status: '${groupBuy.status}',
                endDate: '<fmt:formatDate value="${groupBuy.endDate}" pattern="yyyy-MM-dd HH:mm:ss"/>'
            }${!status.last ? ',' : ''}
            </c:forEach>
        ],

        shippingFee: ${product.shippingFee != null ? product.shippingFee : 0},
        shippingMethodName: '${product.shippingMethodName}',

        // ÌîÑÎ°úÎ™®ÏÖò Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        activePromotions: [
            <c:forEach var="promotion" items="${activePromotions}" varStatus="status">
            {
                id: ${promotion.id},
                name: '${promotion.name}',
                description: '${promotion.description}',
                promotionType: '${promotion.promotionType}',
                discountType: '${promotion.discountType}',
                discountValue: ${promotion.discountValue},
                maxDiscountAmount: ${promotion.maxDiscountAmount != null ? promotion.maxDiscountAmount : 'null'},
                startDate: '<c:out value="${promotion.startDate}"/>',
                endDate: '<c:out value="${promotion.endDate}"/>',
                priority: ${promotion.priority}
            }${!status.last ? ',' : ''}
            </c:forEach>
        ],

        // Ïø†Ìè∞ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        availableCoupons: [
            <c:forEach var="coupon" items="${availableCoupons}" varStatus="status">
            {
                couponId: ${coupon.couponId},
                couponCode: '${coupon.couponCode}',
                name: '${coupon.name}',
                discountType: '${coupon.discountType}',
                discountValue: ${coupon.discountValue},
                minPurchaseAmount: ${coupon.minPurchaseAmount != null ? coupon.minPurchaseAmount : 'null'},
                validFrom: '<c:out value="${coupon.validFrom}" />',
                validTo: '<c:out value="${coupon.validTo}" />',
                applicable: '${coupon.applicable}'
            }${!status.last ? ',' : ''}
            </c:forEach>
        ],

        // ÌòÑÏû¨ ÌîÑÎ°úÎ™®ÏÖò Ìï†Ïù∏ Ï†ïÎ≥¥
        currentDiscount: {
            <c:if test="${not empty proPrice}">
                type: '${proPrice.proDiscountType}',
                value: ${proPrice.proDiscountValue},
                amount:
                <c:choose>
                    <c:when test="${not empty product.variants}">null</c:when>
                    <c:otherwise>
                        <c:choose>
                            <c:when test="${proPrice.proDiscountType eq 'PERCENTAGE'}">
                                Math.floor(${product.basePrice * proPrice.proDiscountValue / 100})
                            </c:when>
                            <c:when test="${proPrice.proDiscountType eq 'FIXED_AMOUNT'}">
                                ${proPrice.proDiscountValue}
                            </c:when>
                            <c:otherwise>0</c:otherwise>
                        </c:choose>
                    </c:otherwise>
                </c:choose>
            </c:if>
        },

        contextPath: '${pageContext.request.contextPath}'
    };

    // ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ (Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏Ïö©)
    <c:choose>
    <c:when test="${not empty sessionScope.loginUser}">
    window.currentUser = {
        id: ${sessionScope.loginUser.id},
        name: '${sessionScope.loginUser.name}'
    };
    </c:when>
    <c:otherwise>
    window.currentUser = null;
    </c:otherwise>
    </c:choose>
</script>
</body>
</html>